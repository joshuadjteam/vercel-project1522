import React, { createContext, useState, useContext, ReactNode, useRef, useCallback, useEffect } from 'react';
import { useAuth } from './useAuth';
import { supabase } from '../supabaseClient';
import { RealtimeChannel } from '@supabase/supabase-js';

const iceServers = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
  ],
};

interface CallContextType {
    isCalling: boolean;
    callee: string;
    callStatus: string;
    isMuted: boolean;
    isVideoEnabled: boolean;
    incomingCall: { from: string; isVideoCall: boolean; } | null;
    localStream: MediaStream | null;
    remoteStream: MediaStream | null;
    callDuration: number;
    startP2PCall: (callee: string, withVideo: boolean) => void;
    acceptCall: () => void;
    declineCall: () => void;
    endCall: () => void;
    toggleMute: () => void;
    toggleVideo: () => void;
}

const CallContext = createContext<CallContextType | undefined>(undefined);

type SoundEffect = 'dial' | 'ring' | 'disconnected' | 'declined';

// Base64 encoded audio files to prevent network/CORS issues and ensure reliability.
const SOUND_DATA_URIS: Record<SoundEffect, string> = {
    dial: 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/8AABBENERflYlEU5URVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERgBoAACYlVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETxZVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER9wVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERuIVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERz8VdXWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZXVpGMjg4A/+xDEAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/8AAEQgDERGg88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//uQxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFU1V//uQxAsgAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/+xDEQAIHEABPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSs0bZzQAE/v8A/9VAAB/gAH/1gEAP76AAAE+H/3+v94AgAAH3oAP+B/AH/k/3wA2f+ABp/4AAn/8AC//4AP//AACwAAAf/8ADf8AIv+ACP/4AA//oAB//QADf/QAP//AA//MAD/4AAf/oAn/8AB//QAUAAAAAP//v/8Av//ABgAAAAAAAAB//+AD///+P/4//z/9P/9//4A///+//8AAAAAABqJmttN/+5DEA8AsAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DEOQAAAM888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//lMQAAAAAGVTU//uQxBgAAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DAE5MAAAAAAAAAAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVPAAAAAD/7kMQfAAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DEJ1o8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//lMQBAAAAAAFVTU//uQxA/AAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DAE5MAAAAAAAAAAAAAVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV-IAAAACAAADSAAAAQAAA+wAABV',
    ring: 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/8AABBENERflYlEU5URVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERgBoAACYlVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERjVYqAAmJFBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERkPZIAAG0lVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERmGI6AAAEjBExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERnWYpAAEklVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERpbmIAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERqjF6EAAMjBExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERrw36AAAD/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERs0kIAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERt/FpBACMABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERxN1eEAAC/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERyqUIAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER0C0CAAAD/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER1e2IAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER3T2CAAAD/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER5MmaAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER6fFqEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER8bFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER+N0aEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER/x2AAAAD/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETCPWaAAAJAARNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETECFqEAAL/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETF/2IAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETHtUaEAAL/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETJhFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETLVV6EAAL/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETNYWaAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETPllKEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETRCFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETTCF6EAAL/BExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETVXFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETXc16EAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETZRFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETbTF6EAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETdgFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETepF6EAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETg/FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETig2GEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETkJ1KAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETmNGGEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETnY1KAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETp62GEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETryFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETtZGGCAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETvBVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETw0GGCAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETykFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETz22GEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET1xVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET3dGGEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET5AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET6U2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET8FlKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET9XWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET/MVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETAF2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETB2lKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETEFWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETFsVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETHHGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETJHVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETK3mGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETNhFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETOWWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETQLVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETRjGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETUFVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETVTGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETXEVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETZBGGEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETa/VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETdGGEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETe6VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETgiGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETiJFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETkUWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETmClKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETnpGGEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETq6lKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETsXmGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETuHVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETv5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETx1FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETz9WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET1xFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET3hGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET5AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET6oGGEAAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET8AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET9smGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET/IFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETAmWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETB5FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETEF2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETFtFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETHHGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETJHVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETK5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETNhFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETOXWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETQIVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETRjmGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETUFVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETVTWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETXEVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETY/WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETa/FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETcg2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETe3VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETgjWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETiJFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETkUWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETmAlKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETno2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETq4VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETsYWGEAAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETuHlKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETv5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETx1FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETz9WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET1xFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET3hGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET5AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET6oGGEAAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENET8AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET9smGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET/IFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETAmWGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETB5FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETEF2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETFtFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETHHGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETJHVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETK5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETNhFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETOXWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETQIVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETRjmGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETUFVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETVTWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETXEVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETY/WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETa/FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETcg2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETe3VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETgjWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETiJFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETkUWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETmAlKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETno2GCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETq4VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETsYWGEAAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETuHlKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETv5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETx1FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETz9WGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENET1xFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET3hGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET5AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET6oGGEAAJABExVVVVVVVVVVVVVVVVVVVX/8AABBENET8AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET9smGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENET/IFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETAmWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETB5FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETEF2GCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETFtFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETHHGGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETJHVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETK5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETNhFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETOXWGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETQIVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETRjmGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETUFVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETVTWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETXEVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETY/WGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETa/FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETcg2GCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETe3VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETgjWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETiJFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETkUWGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETmAlKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETno2GCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETq4VKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETsYWGEAAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETuHlKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETv5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETx1FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETz9WGCEAJABExVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET1xFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET3hGGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENET5AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET6oGGEAAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENET8AFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENET9smGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENET/IFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETAmWGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETB5FKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETEF2GCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETFtFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETHHGGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETJHVKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETK5WGCEAJABExVVVVVVVVVVVVVVVVVVVVVX/8AABBENETNhFKAAEEAAmJVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETOXWGCEAJABExVVVVVVVVVVVVVVVVVVVX/sAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A',
    disconnected: 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/8AABBENERflYlEU5URVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERgBoAACYlVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETxZVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER9wVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERuIVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERz8VdXWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZXVpGMjg4A/+xDEAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/8AAEQgDERGg88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//uQxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFU1V//uQxAsgAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/+xDEQAIHEABPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSs0bZzQAE/v8A/9VAAB/gAH/1gEAP76AAAE+H/3+v94AgAAH3oAP+B/AH/k/3wA2f+ABp/4AAn/8AC//4AP//AACwAAAf/8ADf8AIv+ACP/4AA//oAB//QADf/QAP//AA//MAD/4AAf/oAn/8AB//QAUAAAAAP//v/8Av//ABgAAAAAAAAB//+AD///+P/4//z/9P/9//4A///+//8AAAAAABqJmttN/+5DEA8AsAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DEOQAAAM888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//lMQAAAAAGVTU//uQxBgAAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DAE5MAAAAAAAAAAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV-IAAAACAAADSAAAAQAAA+wAABV',
    declined: 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/8AABBENERflYlEU5URVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERgBoAACYlVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENETxZVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENER9wVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERuIVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/8AABBENERz8VdXWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZXVpGMjg4A/+xDEAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/8AAEQgDERGg88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//uQxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFU1V//uQxAsgAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/+xDEQAIHEABPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSs0bZzQAE/v8A/9VAAB/gAH/1gEAP76AAAE+H/3+v94AgAAH3oAP+B/AH/k/3wA2f+ABp/4AAn/8AC//4AP//AACwAAAf/8ADf8AIv+ACP/4AA//oAB//QADf/QAP//AA//MAD/4AAf/oAn/8AB//QAUAAAAAP//v/8Av//ABgAAAAAAAAB//+AD///+P/4//z/9P/9//4A///+//8AAAAAABqJmttN/+5DEA8AsAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DEOQAAAM888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//lMQAAAAAGVTU//uQxBgAAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DAE5MAAAAAAAAAAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVPAAAAAD/7kMQfAAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DEJ1o8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888//lMQBAAAAAAFVTU//uQxA/AAAANIAYAAAHwAAB1AABJqZ1tQTwAAABYAAApGAAASfAAAAJwAAB8A/9DAE5MAAAAAAAAAAAAAVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV-IAAAACAAADSAAAAQAAA+wAABV',
};

export const CallProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
    const { user } = useAuth();
    const [isCalling, setIsCalling] = useState(false);
    const [callee, setCallee] = useState('');
    const [callStatus, setCallStatus] = useState('');
    const [isMuted, setIsMuted] = useState(false);
    const [isVideoEnabled, setIsVideoEnabled] = useState(true);
    const [incomingCall, setIncomingCall] = useState<{ from: string; isVideoCall: boolean; } | null>(null);
    const [localStream, setLocalStream] = useState<MediaStream | null>(null);
    const [remoteStream, setRemoteStream] = useState<MediaStream | null>(null);
    const [callDuration, setCallDuration] = useState(0);

    const pc = useRef<RTCPeerConnection | null>(null);
    const channel = useRef<RealtimeChannel | null>(null);
    const callTimeoutRef = useRef<number | null>(null);
    const callDurationIntervalRef = useRef<number | null>(null);
    
    // Audio context and sound management
    const audioContextRef = useRef<AudioContext | null>(null);
    const audioBuffersRef = useRef<Partial<Record<SoundEffect, AudioBuffer>>>({});
    const soundSourceRef = useRef<AudioBufferSourceNode | null>(null);
    const isAudioInitialized = useRef(false);

    // Lazy initialization of AudioContext and loading sounds.
    const initializeAudio = useCallback(async () => {
        if (isAudioInitialized.current || !user) return;
        
        try {
            const AudioContext = window.AudioContext || (window as any).webkitAudioContext;
            if (!AudioContext) throw new Error("AudioContext not supported");

            const context = new AudioContext();
            audioContextRef.current = context;

            // Pre-decode all sounds
            const promises = Object.entries(SOUND_DATA_URIS).map(async ([key, dataUri]) => {
                const response = await fetch(dataUri);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await context.decodeAudioData(arrayBuffer);
                audioBuffersRef.current[key as SoundEffect] = audioBuffer;
            });

            await Promise.all(promises);
            isAudioInitialized.current = true;
            console.log("Audio engine for calls initialized successfully.");
        } catch (error) {
            console.error("Failed to initialize audio for calls:", error);
        }
    }, [user]);

    const playSound = useCallback((sound: SoundEffect, loop = false) => {
        if (!isAudioInitialized.current || !audioContextRef.current) return;
        
        // Stop any currently playing sound
        if (soundSourceRef.current) {
            soundSourceRef.current.stop();
            soundSourceRef.current.disconnect();
            soundSourceRef.current = null;
        }

        const buffer = audioBuffersRef.current[sound];
        if (!buffer) return;

        // Resume context if it's suspended (e.g., due to browser autoplay policy)
        if (audioContextRef.current.state === 'suspended') {
            audioContextRef.current.resume();
        }

        const source = audioContextRef.current.createBufferSource();
        source.buffer = buffer;
        source.loop = loop;
        source.connect(audioContextRef.current.destination);
        source.start(0);
        soundSourceRef.current = source;
    }, []);

    const stopSound = useCallback(() => {
        if (soundSourceRef.current) {
            soundSourceRef.current.stop();
            soundSourceRef.current = null;
        }
    }, []);

    const cleanupCall = useCallback(() => {
        console.log("Cleaning up call resources...");
        stopSound();
        if (callTimeoutRef.current) clearTimeout(callTimeoutRef.current);
        if (callDurationIntervalRef.current) clearInterval(callDurationIntervalRef.current);
        callTimeoutRef.current = null;
        callDurationIntervalRef.current = null;

        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        if (pc.current) {
            pc.current.close();
            pc.current = null;
        }

        setIsCalling(false);
        setCallee('');
        setCallStatus('');
        setLocalStream(null);
        setRemoteStream(null);
        setIncomingCall(null);
        setCallDuration(0);
    }, [localStream, stopSound]);
    
    // Subscribe to presence channel when user logs in
    useEffect(() => {
        if (user && !channel.current) {
            const newChannel = supabase.channel(`user-${user.username}`);
            newChannel
                .on('broadcast', { event: 'call-offer' }, ({ payload }) => {
                    if (payload.callee === user.username) {
                        console.log(`Incoming call offer from ${payload.caller}`);
                        setIncomingCall({ from: payload.caller, isVideoCall: payload.isVideoCall });
                        playSound('ring', true);
                        
                        // Set a timeout to automatically decline the call if not answered
                        if (callTimeoutRef.current) clearTimeout(callTimeoutRef.current);
                        callTimeoutRef.current = window.setTimeout(() => {
                             if(incomingCall){ // check if call is still incoming
                                declineCall();
                             }
                        }, 30000); // 30 seconds to answer
                    }
                })
                .on('broadcast', { event: 'call-answer' }, ({ payload }) => {
                    if (payload.caller === user.username && pc.current) {
                        console.log('Received call answer, setting remote description.');
                        pc.current.setRemoteDescription(new RTCSessionDescription(payload.answer));
                    }
                })
                .on('broadcast', { event: 'ice-candidate' }, ({ payload }) => {
                    if (pc.current && payload.recipient === user.username) {
                         console.log("Received ICE candidate, adding to peer connection.");
                        pc.current.addIceCandidate(new RTCIceCandidate(payload.candidate));
                    }
                })
                .on('broadcast', { event: 'call-declined' }, ({ payload }) => {
                    if (payload.caller === user.username) {
                        console.log('Call declined by callee.');
                        playSound('declined');
                        setTimeout(cleanupCall, 2000);
                    }
                })
                 .on('broadcast', { event: 'call-ended' }, ({ payload }) => {
                    if (payload.participant === user.username) {
                        console.log('The other party ended the call.');
                        cleanupCall();
                    }
                })
                .subscribe();
            
            channel.current = newChannel;
        }

        return () => {
            if (channel.current) {
                supabase.removeChannel(channel.current);
                channel.current = null;
            }
        };
    }, [user, playSound, cleanupCall, incomingCall]);

    const createPeerConnection = useCallback((targetUsername: string) => {
        const newPc = new RTCPeerConnection(iceServers);
        newPc.onicecandidate = (event) => {
            if (event.candidate && channel.current && targetUsername) {
                channel.current.send({
                    type: 'broadcast',
                    event: 'ice-candidate',
                    payload: { candidate: event.candidate, recipient: targetUsername },
                });
            }
        };
        newPc.ontrack = (event) => {
            setRemoteStream(event.streams[0]);
        };
        newPc.onconnectionstatechange = () => {
            if(newPc.connectionState === 'connected') {
                setCallStatus('Connected');
                stopSound();
                 if (callDurationIntervalRef.current) clearInterval(callDurationIntervalRef.current);
                 callDurationIntervalRef.current = window.setInterval(() => {
                    setCallDuration(prev => prev + 1);
                }, 1000);
            }
        };
        pc.current = newPc;
        return newPc;
    }, [stopSound]);

    const startP2PCall = useCallback(async (targetUsername: string, withVideo: boolean) => {
        if (!user) return;
        await initializeAudio();

        try {
            // Set callee state first so it's available for the peer connection.
            setCallee(targetUsername);
            
            const stream = await navigator.mediaDevices.getUserMedia({
                video: withVideo,
                audio: true,
            });
            setLocalStream(stream);
            setIsVideoEnabled(withVideo);

            const newPc = createPeerConnection(targetUsername);
            stream.getTracks().forEach(track => newPc.addTrack(track, stream));

            const offer = await newPc.createOffer();
            await newPc.setLocalDescription(offer);

            // Upsert the offer into the database so the callee can retrieve it.
            const { error: offerError } = await supabase
                .from('webrtc_offers')
                .upsert({ caller: user.username, offer: offer }, { onConflict: 'caller' });
    
            if (offerError) {
                console.error('Error saving call offer:', offerError);
                cleanupCall();
                return;
            }

            setIsCalling(true);
            setCallStatus(`Ringing ${targetUsername}...`);
            playSound('dial', true);

            if (channel.current) {
                // The payload no longer contains the full offer.
                channel.current.send({
                    type: 'broadcast',
                    event: 'call-offer',
                    payload: { caller: user.username, callee: targetUsername, isVideoCall: withVideo },
                });
            }
             if (callTimeoutRef.current) clearTimeout(callTimeoutRef.current);
             callTimeoutRef.current = window.setTimeout(() => {
                // Check isCalling and status before timing out
                if (isCalling && callStatus.startsWith('Ringing')) {
                    console.log("Call timed out, user unavailable.");
                    playSound('disconnected');
                    setTimeout(cleanupCall, 2000);
                }
             }, 30000);

        } catch (error) {
            console.error('Error starting call:', error);
            cleanupCall();
        }
    }, [user, createPeerConnection, playSound, cleanupCall, isCalling, callStatus, initializeAudio]);

    const acceptCall = useCallback(async () => {
        if (!incomingCall || !user) return;
        
        await initializeAudio();
        stopSound();
        if (callTimeoutRef.current) clearTimeout(callTimeoutRef.current);

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: incomingCall.isVideoCall,
                audio: true,
            });
            setLocalStream(stream);
            setIsVideoEnabled(incomingCall.isVideoCall);

            // Set the callee state immediately.
            setCallee(incomingCall.from);

            const newPc = createPeerConnection(incomingCall.from);
            stream.getTracks().forEach(track => newPc.addTrack(track, stream));
            
            const { data, error } = await supabase.from('webrtc_offers').select('offer').eq('caller', incomingCall.from).single();
            if (error || !data) throw new Error("Could not retrieve call offer.");
            
            await newPc.setRemoteDescription(new RTCSessionDescription(data.offer));

            const answer = await newPc.createAnswer();
            await newPc.setLocalDescription(answer);

            setIsCalling(true);
            setCallStatus('Connecting...');

            if (channel.current) {
                channel.current.send({
                    type: 'broadcast',
                    event: 'call-answer',
                    payload: { answer, caller: incomingCall.from, callee: user.username },
                });
            }
            setIncomingCall(null);
            
        } catch (error) {
            console.error('Error accepting call:', error);
            cleanupCall();
        }
    }, [incomingCall, user, stopSound, createPeerConnection, cleanupCall, initializeAudio]);

    const declineCall = useCallback(() => {
        if (!incomingCall || !user) return;
        stopSound();
        if (callTimeoutRef.current) clearTimeout(callTimeoutRef.current);
        
        if (channel.current) {
            channel.current.send({
                type: 'broadcast',
                event: 'call-declined',
                payload: { caller: incomingCall.from, callee: user.username },
            });
        }
        setIncomingCall(null);
    }, [incomingCall, user, stopSound]);

    const endCall = useCallback(() => {
        if(channel.current && (callee || incomingCall?.from)) {
            const otherParty = callee || incomingCall?.from;
            channel.current.send({
                type: 'broadcast',
                event: 'call-ended',
                payload: { participant: otherParty }
            });
        }
        cleanupCall();
    }, [cleanupCall, callee, incomingCall]);

    const toggleMute = useCallback(() => {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                setIsMuted(!audioTrack.enabled);
            }
        }
    }, [localStream]);

    const toggleVideo = useCallback(() => {
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                setIsVideoEnabled(videoTrack.enabled);
            }
        }
    }, [localStream]);

    const value = {
        isCalling, callee, callStatus, isMuted, isVideoEnabled,
        incomingCall, localStream, remoteStream, callDuration,
        startP2PCall, acceptCall, declineCall, endCall, toggleMute, toggleVideo,
    };

    return <CallContext.Provider value={value}>{children}</CallContext.Provider>;
};

export const useCall = (): CallContextType => {
    const context = useContext(CallContext);
    if (context === undefined) {
        throw new Error('useCall must be used within a CallProvider');
    }
    return context;
};
